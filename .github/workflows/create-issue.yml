name: Create Issue on Commit to bypass-vip.user.js

on:
  push:
    branches:
      - main
    paths:
      - 'bypass-vip.user.js'

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to check commits

      - name: Create issue for new commits
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const core = require('@actions/core');

            try {
              const commits = context.payload.commits || [];
              core.info(`Processing ${commits.length} commits in the push.`);

              for (const commit of commits) {
                core.info(`Checking commit ${commit.id}: ${commit.message.split('\n')[0]}`);

                // Check if the file was modified in this commit
                let files;
                try {
                  files = execSync(`git show --name-only ${commit.id}`, { encoding: 'utf8' }).split('\n');
                } catch (error) {
                  core.warning(`Failed to get files for commit ${commit.id}: ${error.message}`);
                  continue;
                }

                if (files.includes('bypass-vip.user.js')) {
                  core.info(`File 'bypass-vip.user.js' was modified in commit ${commit.id}.`);

                  // Check for existing issue with this SHA
                  const issues = await github.rest.issues.listForRepo({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    labels: ['auto-generated'],
                    state: 'all'
                  });

                  const existingIssue = issues.data.find(issue =>
                    issue.body && issue.body.includes(`Commit: ${commit.id}`)
                  );

                  if (existingIssue) {
                    core.info(`Issue already exists for commit ${commit.id}: #${existingIssue.number}`);
                    continue;
                  }

                  // Get the file content at this commit
                  let fileContent = '';
                  try {
                    const fileResponse = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: 'bypass-vip.user.js',
                      ref: commit.id
                    });
                    fileContent = Buffer.from(fileResponse.data.content, 'base64').toString('utf8');
                  } catch (error) {
                    core.warning(`Failed to get file content for commit ${commit.id}: ${error.message}`);
                    fileContent = 'Unable to retrieve file content.';
                  }

                  // Create new issue
                  const title = `New commit to 'bypass-vip.user.js' (see below for file content): ${commit.message.split('\n')[0]}`;
                  const body = `**Commit Details:**

- **SHA:** \`${commit.id}\`
- **Author:** ${commit.author.name} <${commit.author.email}>
- **Link:** https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commit.id}

**Commit Message:**
${commit.message}

**Description of Changes:**
This issue was automatically created because the file \`bypass-vip.user.js\` was modified in this commit.

**File Content (bypass-vip.user.js):**
\`\`\`javascript
${fileContent}
\`\`\``;

                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title,
                    body,
                    labels: ['auto-generated']
                  });

                  core.info(`Created issue for commit ${commit.id}`);
                } else {
                  core.info(`File 'bypass-vip.user.js' was not modified in commit ${commit.id}.`);
                }
              }
            } catch (error) {
              core.setFailed(`Error in script: ${error.message}`);
              console.error(error);
            }