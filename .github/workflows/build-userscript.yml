name: Build Userscript

on:
  push:
    paths:
      - 'package.json'

jobs:
  release-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1

    - name: Install dependencies
      run: bun install

    - name: Build userscript
      run: bun run build

    - name: Get Date
      id: date
      run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

    - name: Get Version
      id: version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Check if tag exists
      id: tag_exists
      run: |
        TAG_NAME="${{ steps.version.outputs.version }}"
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Tag
      if: steps.tag_exists.outputs.exists == 'false'
      run: |
        TAG_NAME="${{ steps.version.outputs.version }}"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"

    - name: Generate Changelog
      id: changelog
      run: |
        CURRENT_TAG="${{ steps.version.outputs.version }}"
        # Find the most recent tag before the current one
        # If this is the first tag, PREVIOUS_TAG will be empty
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 --exclude="$CURRENT_TAG" 2>/dev/null || echo "")

        echo "Current Tag: $CURRENT_TAG"
        echo "Previous Tag: $PREVIOUS_TAG"

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found. Getting all logs."
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          echo "Getting logs between $PREVIOUS_TAG and $CURRENT_TAG"
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG..$CURRENT_TAG" --no-merges)
        fi

        # Escape for GITHUB_OUTPUT
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Fetch Contributors
      id: contributors
      uses: actions/github-script@v7
      with:
        result-encoding: string
        script: |
          const { data: contributors } = await github.rest.repos.listContributors({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 50
          });
          const login = context.actor;
          const contributorLogins = contributors
            .filter(c => c.login !== login)
            .map(c => `- ${c.login}`)
            .join('\n');
          return contributorLogins;

    - name: Create Release
      if: steps.tag_exists.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2.5.0
      with:
        files: ReBypass.user.js
        tag_name: ${{ steps.version.outputs.version }}
        body: |
          Release **ReBypass** artifact, generated on **${{ steps.date.outputs.date }}**

          ## Changelog

          ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
