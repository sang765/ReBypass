name: Build Userscript Release

on:
  pull_request:
    types: [closed]
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  release-build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1

    - name: Install dependencies
      run: bun install

    - name: Build userscript
      run: bun run build

    - name: Build no-update userscript
      run: bun run build:no-update

    - name: Get Date
      id: date
      run: echo "date=$(date +'%Y/%m/%d')" >> $GITHUB_OUTPUT

    - name: Get Time
      id: time
      run: echo "time=$(date +'%I:%M:%S %p')" >> $GITHUB_OUTPUT

    - name: Get Version
      id: version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Check if tag exists
      id: tag_exists
      run: |
        TAG_NAME="${{ steps.version.outputs.version }}"
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Tag
      if: steps.tag_exists.outputs.exists == 'false'
      run: |
        TAG_NAME="${{ steps.version.outputs.version }}"
        git tag "$TAG_NAME"
        git push origin "$TAG_NAME"

    - name: Generate Changelog
      id: changelog
      run: |
        CURRENT_TAG="${{ steps.version.outputs.version }}"

        # Get all tags sorted by version, excluding current tag
        ALL_TAGS=$(git tag -l | grep -v "^${CURRENT_TAG}$" | sort -V | tail -n +1)

        # Get the most recent tag before current one
        PREVIOUS_TAG=$(git tag -l | grep -v "^${CURRENT_TAG}$" | sort -V | tail -n 1)

        echo "Current Tag: $CURRENT_TAG"
        echo "Previous Tag: $PREVIOUS_TAG"

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found. Getting all logs."
          CHANGELOG=$(git log --pretty=format:"- (%h): **\"%s\"** by **@%an**" --no-merges)
        else
          echo "Getting logs between $PREVIOUS_TAG and $CURRENT_TAG"
          CHANGELOG=$(git log --pretty=format:"- (%h): **\"%s\"** by **@%an**" "$PREVIOUS_TAG..$CURRENT_TAG" --no-merges)
        fi

        # Escape for GITHUB_OUTPUT
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Fetch Contributors
      id: contributors
      uses: actions/github-script@v7
      with:
        result-encoding: string
        script: |
          const { data: contributors } = await github.rest.repos.listContributors({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 50
          });
          const login = context.actor;
          const contributorLogins = contributors
            .filter(c => c.login !== login)
            .map(c => `- ${c.login}`)
            .join('\n');
          return contributorLogins;

    - name: Create Release
      if: steps.tag_exists.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2.5.0
      with:
        files: |
          ReBypass.user.js
          ReBypass-No-Update.user.js
        tag_name: ${{ steps.version.outputs.version }}
        body: |
          Release **ReBypass** artifact, generated on **${{ steps.date.outputs.date }} - ${{ steps.time.outputs.time }}**

          ## Changelog

          ${{ steps.changelog.outputs.changelog }}

          ## Install Userscript

          ### Latest Version:

          [![Install Latest Version](https://img.shields.io/github/v/release/sang765/ReBypass?display_name=release&style=for-the-badge&logo=javascript&logoColor=yellow&label=Latest&color=light%20green)](https://github.com/sang765/ReBypass/releases/latest/download/ReBypass.user.js)

          ### Current Version:

          > [!WARNING]
          > **Remember that**
          > - Installing this version means it will **not be updated** version, so please consider carefully before installing.

          [![Install Current Version](https://img.shields.io/badge/Current-v${{ steps.version.outputs.version }}-darkred?style=for-the-badge&logo=javascript&logoColor=Yellow)](https://github.com/sang765/ReBypass/releases/download/${{ steps.version.outputs.version }}/ReBypass-No-Update.user.js)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
